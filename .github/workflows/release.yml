name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD || secrets.QUAY_TOKEN }}
      
      - name: Get version
        id: version
        run: |
          if [[ -f .version ]]; then
            VERSION=$(cat .version | tr -d '[:space:]')
          else
            # Extract from latest tag if .version doesn't exist
            VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//' || echo "0.1.0")
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
      
      - name: Create release tag
        id: tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"
          
          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping"
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Created and pushed tag: $TAG"
          fi
      
      - name: Get commit SHA
        id: commit
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Build and push container image
        if: steps.tag.outputs.exists == 'false'
        run: |
          IMAGE_NAME="eip-monitor"
          REGISTRY="quay.io/${{ secrets.QUAY_REPOSITORY }}"
          VERSION="${{ steps.version.outputs.version }}"
          SHA="${{ steps.commit.outputs.sha }}"
          
          # Build image
          docker build --platform linux/amd64 -t ${REGISTRY}/${IMAGE_NAME}:v${VERSION} .
          docker tag ${REGISTRY}/${IMAGE_NAME}:v${VERSION} ${REGISTRY}/${IMAGE_NAME}:latest
          docker tag ${REGISTRY}/${IMAGE_NAME}:v${VERSION} ${REGISTRY}/${IMAGE_NAME}:sha-${SHA}
          
          # Push images
          docker push ${REGISTRY}/${IMAGE_NAME}:v${VERSION}
          docker push ${REGISTRY}/${IMAGE_NAME}:latest
          docker push ${REGISTRY}/${IMAGE_NAME}:sha-${SHA}
          
          echo "Pushed images:"
          echo "  - ${REGISTRY}/${IMAGE_NAME}:v${VERSION}"
          echo "  - ${REGISTRY}/${IMAGE_NAME}:latest"
          echo "  - ${REGISTRY}/${IMAGE_NAME}:sha-${SHA}"
      
      - name: Generate release notes
        id: notes
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [[ -n "$PREV_TAG" ]]; then
            NOTES=$(git log ${PREV_TAG}..HEAD --oneline --no-merges | sed 's/^/- /')
          else
            NOTES=$(git log --oneline --no-merges -20 | sed 's/^/- /')
          fi
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub release
        if: steps.tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## Release ${{ steps.tag.outputs.tag }}
            
            ### Container Images
            - `quay.io/${{ secrets.QUAY_REPOSITORY }}/eip-monitor:v${{ steps.version.outputs.version }}`
            - `quay.io/${{ secrets.QUAY_REPOSITORY }}/eip-monitor:latest`
            - `quay.io/${{ secrets.QUAY_REPOSITORY }}/eip-monitor:sha-${{ steps.commit.outputs.sha }}`
            
            ### Changes
            ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false

