name: Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}
      
      - name: Get version and tag
        id: release
        run: |
          # If triggered by tag push, use that tag
          if [[ -n "${{ github.ref_type }}" ]] && [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            VERSION=$(echo "$TAG" | sed 's/^v//')
            echo "Triggered by tag push: $TAG"
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            # Triggered by branch push - check .version file and find matching tag
            if [[ -f .version ]]; then
              VERSION=$(cat .version | tr -d '[:space:]')
            else
              # Extract from latest tag if .version doesn't exist
              VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//' || echo "0.1.0")
            fi
            TAG="v${VERSION}"
            
            # Check if tag exists and is in current branch history
            if git rev-parse "$TAG" >/dev/null 2>&1; then
              TAG_COMMIT=$(git rev-parse "$TAG")
              HEAD_COMMIT=$(git rev-parse HEAD)
              
              # Check if tag commit is in current branch history (ancestor of HEAD)
              if git merge-base --is-ancestor "$TAG_COMMIT" "$HEAD_COMMIT" 2>/dev/null; then
                # Tag is in branch history - build it
                echo "Tag $TAG exists and is in branch history, building release"
                echo "tag=${TAG}" >> $GITHUB_OUTPUT
                echo "version=${VERSION}" >> $GITHUB_OUTPUT
                echo "should_build=true" >> $GITHUB_OUTPUT
              else
                echo "Tag $TAG exists but is not in current branch history, skipping build"
                echo "tag=${TAG}" >> $GITHUB_OUTPUT
                echo "version=${VERSION}" >> $GITHUB_OUTPUT
                echo "should_build=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "Tag $TAG does not exist, skipping build"
              echo "tag=${TAG}" >> $GITHUB_OUTPUT
              echo "version=${VERSION}" >> $GITHUB_OUTPUT
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          fi
          echo "Version: ${VERSION}"
          echo "Tag: ${TAG}"
      
      - name: Get commit SHA
        id: commit
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Build and push container image
        if: steps.release.outputs.should_build == 'true'
        run: |
          IMAGE_NAME="eip-monitor"
          REGISTRY="quay.io/${{ secrets.QUAY_REPOSITORY }}"
          VERSION="${{ steps.release.outputs.version }}"
          SHA="${{ steps.commit.outputs.sha }}"
          
          # Build image
          docker build --platform linux/amd64 -t ${REGISTRY}/${IMAGE_NAME}:v${VERSION} .
          docker tag ${REGISTRY}/${IMAGE_NAME}:v${VERSION} ${REGISTRY}/${IMAGE_NAME}:latest
          docker tag ${REGISTRY}/${IMAGE_NAME}:v${VERSION} ${REGISTRY}/${IMAGE_NAME}:sha-${SHA}
          
          # Push images
          docker push ${REGISTRY}/${IMAGE_NAME}:v${VERSION}
          docker push ${REGISTRY}/${IMAGE_NAME}:latest
          docker push ${REGISTRY}/${IMAGE_NAME}:sha-${SHA}
          
          echo "Pushed images:"
          echo "  - ${REGISTRY}/${IMAGE_NAME}:v${VERSION}"
          echo "  - ${REGISTRY}/${IMAGE_NAME}:latest"
          echo "  - ${REGISTRY}/${IMAGE_NAME}:sha-${SHA}"
      
      - name: Generate release notes
        id: notes
        if: steps.release.outputs.should_build == 'true'
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [[ -n "$PREV_TAG" ]]; then
            NOTES=$(git log ${PREV_TAG}..HEAD --oneline --no-merges | sed 's/^/- /')
          else
            NOTES=$(git log --oneline --no-merges -20 | sed 's/^/- /')
          fi
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub release
        if: steps.release.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: Release ${{ steps.release.outputs.tag }}
          body: |
            ## Release ${{ steps.release.outputs.tag }}
            
            ### Container Images
            - `quay.io/${{ secrets.QUAY_REPOSITORY }}/eip-monitor:v${{ steps.release.outputs.version }}`
            - `quay.io/${{ secrets.QUAY_REPOSITORY }}/eip-monitor:latest`
            - `quay.io/${{ secrets.QUAY_REPOSITORY }}/eip-monitor:sha-${{ steps.commit.outputs.sha }}`
            
            ### Changes
            ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false

