name: Staging Integration

on:
  push:
    branches: [staging]

jobs:
  integrate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Verify quay.io secrets
        run: |
          if [[ -z "${{ secrets.QUAY_USERNAME }}" ]]; then
            echo "ERROR: QUAY_USERNAME secret is not set"
            exit 1
          fi
          if [[ -z "${{ secrets.QUAY_TOKEN }}" ]]; then
            echo "ERROR: QUAY_TOKEN secret is not set"
            exit 1
          fi
          if [[ -z "${{ secrets.QUAY_REPOSITORY }}" ]]; then
            echo "ERROR: QUAY_REPOSITORY secret is not set"
            exit 1
          fi
          echo "âœ“ All quay.io secrets are set"
          echo "Repository: quay.io/${{ secrets.QUAY_REPOSITORY }}/eip-monitor"
      
      - name: Log in to quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}
      
      - name: Bump version
        id: version
        run: |
          # Determine bump type from commit messages (default: patch)
          BUMP_TYPE="patch"
          if git log --oneline -1 | grep -qiE "feat|feature|minor"; then
            BUMP_TYPE="minor"
          fi
          if git log --oneline -1 | grep -qiE "breaking|major"; then
            BUMP_TYPE="major"
          fi
          
          export BUMP_TYPE
          if [[ -f scripts/bump-version.sh ]]; then
            NEW_VERSION=$(./scripts/bump-version.sh)
          else
            # Fallback: manual version bump
            if [[ ! -f .version ]]; then
              echo "0.1.0" > .version
            fi
            CURRENT_VERSION=$(cat .version | tr -d '[:space:]')
            IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
            case "$BUMP_TYPE" in
              major) NEW_VERSION="$((major + 1)).0.0" ;;
              minor) NEW_VERSION="${major}.$((minor + 1)).0" ;;
              *) NEW_VERSION="${major}.${minor}.$((patch + 1))" ;;
            esac
            echo "$NEW_VERSION" > .version
          fi
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "bump_type=${BUMP_TYPE}" >> $GITHUB_OUTPUT
          
          # Commit version bump
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .version
          git commit -m "chore: bump version to ${NEW_VERSION}" || echo "No version change needed"
          git push origin HEAD:staging
      
      - name: Get RC number
        id: rc
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Count existing RC tags for this version
          RC_COUNT=$(git tag -l "v${VERSION}-rc*" | wc -l | tr -d ' ')
          RC_NUM=$((RC_COUNT + 1))
          echo "rc=${RC_NUM}" >> $GITHUB_OUTPUT
      
      - name: Create pre-release tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RC="${{ steps.rc.outputs.rc }}"
          TAG="v${VERSION}-rc${RC}"
          git tag -a "$TAG" -m "Pre-release $TAG"
          git push origin "$TAG"
          echo "Created pre-release tag: $TAG"
      
      - name: Get commit SHA
        id: commit
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Get date
        id: date
        run: echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Build and push container image
        id: build
        run: |
          IMAGE_NAME="eip-monitor"
          REGISTRY="quay.io/${{ secrets.QUAY_REPOSITORY }}"
          VERSION="${{ steps.version.outputs.version }}"
          RC="${{ steps.rc.outputs.rc }}"
          DATE="${{ steps.date.outputs.date }}"
          SHA="${{ steps.commit.outputs.sha }}"
          
          # Build image
          docker build --platform linux/amd64 -t ${REGISTRY}/${IMAGE_NAME}:v${VERSION}-rc${RC} .
          docker tag ${REGISTRY}/${IMAGE_NAME}:v${VERSION}-rc${RC} ${REGISTRY}/${IMAGE_NAME}:staging-${DATE}
          docker tag ${REGISTRY}/${IMAGE_NAME}:v${VERSION}-rc${RC} ${REGISTRY}/${IMAGE_NAME}:sha-${SHA}
          
          # Push images
          docker push ${REGISTRY}/${IMAGE_NAME}:v${VERSION}-rc${RC}
          docker push ${REGISTRY}/${IMAGE_NAME}:staging-${DATE}
          docker push ${REGISTRY}/${IMAGE_NAME}:sha-${SHA}
          
          # Export image name for use in subsequent steps
          echo "image=${REGISTRY}/${IMAGE_NAME}:v${VERSION}-rc${RC}" >> $GITHUB_OUTPUT
          echo "image_staging=${REGISTRY}/${IMAGE_NAME}:staging-${DATE}" >> $GITHUB_OUTPUT
          echo "image_sha=${REGISTRY}/${IMAGE_NAME}:sha-${SHA}" >> $GITHUB_OUTPUT
      
      - name: Run integration tests
        continue-on-error: true
        run: |
          echo "Running integration tests..."
          # Placeholder for integration test execution
          # Would require OpenShift cluster access
          # Note: Cluster is not publicly accessible, so tests must be run manually
          echo "Integration tests would run here if configured"
          echo ""
          echo "To run e2e tests manually, use:"
          echo "  EIP_MONITOR_IMAGE=\"${{ steps.build.outputs.image }}\" MONITORING_TYPE=coo ./tests/e2e/test-monitoring-e2e.sh"
      
      - name: Generate test report
        if: always()
        run: |
          echo "## Staging Integration Results" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-release tag: v${{ steps.version.outputs.version }}-rc${{ steps.rc.outputs.rc }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Container Images Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following container images have been built and pushed to quay.io:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Primary Image**: \`${{ steps.build.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Staging Tag**: \`${{ steps.build.outputs.image_staging }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA Tag**: \`${{ steps.build.outputs.image_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Deployment and Testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Since the OpenShift cluster is not publicly accessible, deployment and e2e tests must be run manually:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Connect to your OpenShift cluster:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   oc login --token=<token> --server=<server>" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Deploy the eip-monitor application:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   ./scripts/deploy-eip.sh deploy --quay-image \"${{ steps.build.outputs.image }}\"" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Run e2e tests:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   EIP_MONITOR_IMAGE=\"${{ steps.build.outputs.image }}\" MONITORING_TYPE=coo ./tests/e2e/test-monitoring-e2e.sh" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "   Or for UWM monitoring:" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   EIP_MONITOR_IMAGE=\"${{ steps.build.outputs.image }}\" MONITORING_TYPE=uwm ./tests/e2e/test-monitoring-e2e.sh" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY

