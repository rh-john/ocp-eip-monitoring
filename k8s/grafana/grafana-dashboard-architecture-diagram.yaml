---
# EIP Architecture Diagram Dashboard (FlowCharting/Diagram)
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: eip-architecture-diagram
  namespace: eip-monitoring
  labels:
    app: eip-monitor
spec:
  instanceSelector:
    matchLabels:
      app: eip-monitor
  json: |
    {
      "id": null,
      "title": "EIP Architecture Diagram",
      "tags": ["eip", "architecture", "diagram", "flowchart"],
      "style": "dark",
      "timezone": "browser",
      "refresh": "30s",
      "schemaVersion": 16,
      "version": 1,
      "panels": [
        {
          "id": 1,
          "title": "EIP Assignment Flow",
          "type": "jdbranham-diagram-panel",
          "gridPos": {"h": 12, "w": 24, "x": 0, "y": 0},
          "pluginVersion": "1.0.0",
          "options": {
            "content": "graph TD\n    A[EIP Configured] --> B{Node Available?}\n    B -->|Yes| C[Assign to Node]\n    B -->|No| D[Pending State]\n    C --> E[CPIC Created]\n    E --> F{CPIC Success?}\n    F -->|Yes| G[EIP Active ✓]\n    F -->|No| H[CPIC Error ✗]\n    H --> I[Redistribute to Healthy Node]\n    I --> C\n    D --> B\n    G --> J[Monitor Status]\n    J --> K{Health Check}\n    K -->|Healthy| J\n    K -->|Unhealthy| I\n    \n    style A fill:#4a90e2,stroke:#2e5c8a,stroke-width:2px\n    style G fill:#52c41a,stroke:#389e0d,stroke-width:2px\n    style H fill:#ff4d4f,stroke:#cf1322,stroke-width:2px\n    style D fill:#faad14,stroke:#d48806,stroke-width:2px"
          }
        },
        {
          "id": 2,
          "title": "Node EIP Distribution",
          "type": "bargauge",
          "gridPos": {"h": 12, "w": 12, "x": 0, "y": 12},
          "targets": [
            {
              "expr": "sum by (node) (node_eip_assigned_total)",
              "legendFormat": "{{node}}",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": null, "color": "green"},
                  {"value": 10, "color": "yellow"},
                  {"value": 20, "color": "orange"},
                  {"value": 30, "color": "red"}
                ]
              },
              "unit": "short"
            }
          },
          "options": {
            "orientation": "horizontal",
            "displayMode": "gradient",
            "showUnfilled": true,
            "legend": {
              "displayMode": "list",
              "placement": "bottom"
            }
          }
        },
        {
          "id": 3,
          "title": "EIP Status Summary",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 12},
          "targets": [
            {
              "expr": "eips_configured_total",
              "legendFormat": "Configured",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": null, "color": "blue"}
                ]
              },
              "unit": "short"
            }
          }
        },
        {
          "id": 4,
          "title": "Assigned EIPs",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 12},
          "targets": [
            {
              "expr": "eips_assigned_total",
              "legendFormat": "Assigned",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": null, "color": "green"}
                ]
              },
              "unit": "short"
            }
          }
        },
        {
          "id": 5,
          "title": "Unassigned EIPs",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 16},
          "targets": [
            {
              "expr": "eips_unassigned_total",
              "legendFormat": "Unassigned",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": null, "color": "red"}
                ]
              },
              "unit": "short"
            }
          }
        },
        {
          "id": 6,
          "title": "CPIC Success Rate",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 16},
          "targets": [
            {
              "expr": "(cpic_success_total / (cpic_success_total + cpic_error_total + cpic_pending_total)) * 100",
              "legendFormat": "Success Rate",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": null, "color": "red"},
                  {"value": 80, "color": "yellow"},
                  {"value": 95, "color": "green"}
                ]
              },
              "unit": "percent",
              "decimals": 1
            }
          }
        },
        {
          "id": 7,
          "title": "EIP Lifecycle Sequence",
          "type": "jdbranham-diagram-panel",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 20},
          "pluginVersion": "1.0.0",
          "options": {
            "content": "sequenceDiagram\n    participant User\n    participant EIP as EgressIP\n    participant Node\n    participant CPIC as CloudPrivateIPConfig\n    participant Monitor\n    \n    User->>EIP: Create EgressIP\n    EIP->>Node: Check Availability\n    alt Node Available\n        EIP->>Node: Assign EIP\n        Node->>CPIC: Create CPIC\n        CPIC-->>Node: Status\n        alt CPIC Success\n            CPIC->>EIP: Active\n            EIP-->>User: EIP Ready\n            Monitor->>EIP: Health Check\n        else CPIC Error\n            CPIC->>EIP: Error\n            EIP->>Node: Redistribute\n        end\n    else No Node Available\n        EIP->>EIP: Pending\n    end"
          }
        },
        {
          "id": 8,
          "title": "EIP Metrics Overview",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 28},
          "targets": [
            {
              "expr": "eips_configured_total",
              "legendFormat": "Configured",
              "refId": "A"
            },
            {
              "expr": "eips_assigned_total",
              "legendFormat": "Assigned",
              "refId": "B"
            },
            {
              "expr": "eips_unassigned_total",
              "legendFormat": "Unassigned",
              "refId": "C"
            },
            {
              "expr": "cpic_success_total",
              "legendFormat": "CPIC Success",
              "refId": "D"
            },
            {
              "expr": "cpic_error_total",
              "legendFormat": "CPIC Error",
              "refId": "E"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "unit": "short"
            }
          },
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "bottom"
            },
            "tooltip": {
              "mode": "multi"
            }
          }
        }
      ]
    }

